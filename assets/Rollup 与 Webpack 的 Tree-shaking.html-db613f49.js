import{_ as e,z as o,A as l,Y as n,C as s,U as p,a6 as t,Q as c}from"./framework-cb9358d9.js";const i={},r=n("p",null,[n("img",{src:"https://p9-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/bfefad3ee3474e3a8a461251aaddceb4~tplv-k3u1fbpfcp-watermark.image?",alt:"政采云技术团队.png"})],-1),u=n("p",null,[n("img",{src:"https://p1-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/1dea02686df0430ab66fd4e7091549a5~tplv-k3u1fbpfcp-watermark.image?",alt:"清音.png"})],-1),k={href:"http://zoo.zhengcaiyun.cn/blog/article/tree-shaking",target:"_blank",rel:"noopener noreferrer"},d=t(`<p>Rollup 和 Webpack 是目前项目中使用较为广泛的两种打包工具，去年发布的 Vite 中打包所依赖的也是 Rollup；在对界面加载效率要求越来越高的今天，打包工具最终产出的包体积也影响着开发人员对工具的选择，所以对 Tree-shaking 的支持程度和配置的便捷性、有效性就尤为重要了。本文就来简单分析下两者 Tree-shaking 的流程和效果差异。</p><h4 id="tree-shaking-的目的" tabindex="-1"><a class="header-anchor" href="#tree-shaking-的目的" aria-hidden="true">#</a> Tree-shaking 的目的</h4><p>Tree-shaking 的目标只有一个，去除无用代码，缩小最终的包体积，至于什么算是无用代码呢？主要分为三类：</p><ol><li>代码不会被执行，不可到达</li><li>代码执行的结果不会被用到</li><li>代码只会影响死变量（只写不读） Tree-shaking 的目的就是将这三类代码在最终包中剔除，做到按需引入。</li></ol><h4 id="为什么-tree-shaking-需要依赖-es6-module" tabindex="-1"><a class="header-anchor" href="#为什么-tree-shaking-需要依赖-es6-module" aria-hidden="true">#</a> 为什么 Tree-shaking 需要依赖 ES6 module</h4><p>ES6 module 特点：</p><ul><li>只能作为模块顶层的语句出现</li><li>import 的模块名只能是字符串常量</li><li>import 之后是不可修改的 例如，在使用 CommonJS 时，<em>必须导入完整的工具 (tool) 或库 (library) 对象</em>，且可带有条件判断来决定是否导入。</li></ul><div class="language-plain line-numbers-mode" data-ext="plain"><pre class="language-plain"><code>// 使用 CommonJS 导入完整的 utils 对象
if (hasRequest) {
  const utils = require( &amp;#39;utils&amp;#39; );
}
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>但是在使用 ES6 模块时，无需导入整个 <code>utils</code> 对象，我们可以只导入我们所需使用的 <code>request</code> 函数，但此处的 import 是不能在任何条件语句下进行的，否则就会报错。</p><div class="language-plain line-numbers-mode" data-ext="plain"><pre class="language-plain"><code>// 使用 ES6 import 语句导入 request 函数
import { request } from &amp;#39;utils&amp;#39;;
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div></div></div><p>ES6 模块依赖关系是确定的，和运行时的状态无关，因此可以进行可靠的静态分析，这就是 Tree-shaking 的基础。</p><p>静态分析就是不执行代码，直接对代码进行分析；在 ES6 之前的模块化，比如上面提到的 CommonJS ，我们可以动态 require 一个模块，只有执行后才知道引用的什么模块，这就使得我们不能直接静态的进行分析。</p><h3 id="wepack5-x-tree-shaking-机制" tabindex="-1"><a class="header-anchor" href="#wepack5-x-tree-shaking-机制" aria-hidden="true">#</a> Wepack5.x Tree-shaking 机制</h3><p>Webpack 2 正式版本内置支持 ES2015 模块（也叫做 <em>harmony modules</em>）和未使用模块检测能力。Webpack 4 正式版本扩展了此检测能力，通过 <code>package.json</code> 的 <code>&amp;quot;sideEffects&amp;quot;</code> 属性作为标记，向 compiler 提供提示，表明项目中的哪些文件是 &quot;pure (纯正 ES2015 模块)&quot;，由此可以安全地删除文件中未使用的部分。Webpack 5 中内置了 terser-webpack-plugin 插件用于 JS 代码压缩，相较于 Webpack 4 来说，无需再额外下载安装，但如果开发者需要增加自定义配置项，那还是需要安装。</p><p>Wepack 自身在编译过程中，会根据模块的 <code>import</code> 与 <code>export</code> 依赖分析对代码块进行打标。</p><div class="language-javascript line-numbers-mode" data-ext="js"><pre class="language-javascript"><code><span class="token doc-comment comment">/**
   * <span class="token keyword">@param</span> <span class="token class-name"><span class="token punctuation">{</span>Context<span class="token punctuation">}</span></span> <span class="token parameter">context</span> context
   * <span class="token keyword">@returns</span> <span class="token class-name"><span class="token punctuation">{</span>string<span class="token operator">|</span>Source<span class="token punctuation">}</span></span> the source code that will be included as initialization code
   */</span>
  <span class="token function">getContent</span><span class="token punctuation">(</span><span class="token parameter"><span class="token punctuation">{</span> runtimeTemplate<span class="token punctuation">,</span> runtimeRequirements <span class="token punctuation">}</span></span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    runtimeRequirements<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>RuntimeGlobals<span class="token punctuation">.</span>exports<span class="token punctuation">)</span><span class="token punctuation">;</span>
    runtimeRequirements<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>RuntimeGlobals<span class="token punctuation">.</span>definePropertyGetters<span class="token punctuation">)</span><span class="token punctuation">;</span>
​    <span class="token comment">// 未使用的模块, 在代码块前增加 unused harmony exports 注释标记</span>
    <span class="token keyword">const</span> unusedPart <span class="token operator">=</span>
      <span class="token keyword">this</span><span class="token punctuation">.</span>unusedExports<span class="token punctuation">.</span>size <span class="token operator">&amp;</span>gt<span class="token punctuation">;</span> <span class="token number">1</span>
        <span class="token operator">?</span> <span class="token template-string"><span class="token template-punctuation string">\`</span><span class="token string">/* unused harmony exports </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">\${</span><span class="token function">joinIterableWithComma</span><span class="token punctuation">(</span>
            <span class="token keyword">this</span><span class="token punctuation">.</span>unusedExports
          <span class="token punctuation">)</span><span class="token interpolation-punctuation punctuation">}</span></span><span class="token string"> */\\n</span><span class="token template-punctuation string">\`</span></span>
        <span class="token operator">:</span> <span class="token keyword">this</span><span class="token punctuation">.</span>unusedExports<span class="token punctuation">.</span>size <span class="token operator">&amp;</span>gt<span class="token punctuation">;</span> <span class="token number">0</span>
        <span class="token operator">?</span> <span class="token template-string"><span class="token template-punctuation string">\`</span><span class="token string">/* unused harmony export </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">\${</span><span class="token function">first</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>unusedExports<span class="token punctuation">)</span><span class="token interpolation-punctuation punctuation">}</span></span><span class="token string"> */\\n</span><span class="token template-punctuation string">\`</span></span>
        <span class="token operator">:</span> <span class="token operator">&amp;</span>quot<span class="token punctuation">;</span><span class="token operator">&amp;</span>quot<span class="token punctuation">;</span><span class="token punctuation">;</span>
    <span class="token keyword">const</span> definitions <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token keyword">const</span> orderedExportMap <span class="token operator">=</span> Array<span class="token punctuation">.</span><span class="token function">from</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>exportMap<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">sort</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">[</span>a<span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token punctuation">[</span>b<span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token operator">=</span><span class="token operator">&amp;</span>gt<span class="token punctuation">;</span>
      a <span class="token operator">&amp;</span>lt<span class="token punctuation">;</span> b <span class="token operator">?</span> <span class="token operator">-</span><span class="token number">1</span> <span class="token operator">:</span> <span class="token number">1</span>
    <span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// 对 harmony export 进行打标</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">const</span> <span class="token punctuation">[</span>key<span class="token punctuation">,</span> value<span class="token punctuation">]</span> <span class="token keyword">of</span> orderedExportMap<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      definitions<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>
        <span class="token template-string"><span class="token template-punctuation string">\`</span><span class="token string">\\n/* harmony export */   </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">\${</span><span class="token constant">JSON</span><span class="token punctuation">.</span><span class="token function">stringify</span><span class="token punctuation">(</span>
          key
        <span class="token punctuation">)</span><span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">: </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">\${</span>runtimeTemplate<span class="token punctuation">.</span><span class="token function">returningFunction</span><span class="token punctuation">(</span>value<span class="token punctuation">)</span><span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">\`</span></span>
      <span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    
    <span class="token comment">// 对 harmony export 进行打标</span>
    <span class="token keyword">const</span> definePart <span class="token operator">=</span>
      <span class="token keyword">this</span><span class="token punctuation">.</span>exportMap<span class="token punctuation">.</span>size <span class="token operator">&amp;</span>gt<span class="token punctuation">;</span> <span class="token number">0</span>
        <span class="token operator">?</span> <span class="token template-string"><span class="token template-punctuation string">\`</span><span class="token string">/* harmony export */ </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">\${</span>RuntimeGlobals<span class="token punctuation">.</span>definePropertyGetters<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">(</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">\${</span>
            <span class="token keyword">this</span><span class="token punctuation">.</span>exportsArgument
          <span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">, {</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">\${</span>definitions<span class="token punctuation">.</span><span class="token function">join</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>quot<span class="token punctuation">;</span><span class="token punctuation">,</span><span class="token operator">&amp;</span>quot<span class="token punctuation">;</span><span class="token punctuation">)</span><span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">\\n/* harmony export */ });\\n</span><span class="token template-punctuation string">\`</span></span>
        <span class="token operator">:</span> <span class="token operator">&amp;</span>quot<span class="token punctuation">;</span><span class="token operator">&amp;</span>quot<span class="token punctuation">;</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> <span class="token template-string"><span class="token template-punctuation string">\`</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">\${</span>definePart<span class="token interpolation-punctuation punctuation">}</span></span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">\${</span>unusedPart<span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">\`</span></span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>上面是从 Webpack 中截取的打标代码，可以看到主要会有两类标记，<code>harmony export</code> 和 <code>unused harmony export</code> 分别代表了有用与无用。标记完成后打包时 Teser 会将无用的模块去除。</p>`,17),m={id:"rollup-tree-shaking-机制",tabindex:"-1"},v=n("a",{class:"header-anchor",href:"#rollup-tree-shaking-机制","aria-hidden":"true"},"#",-1),b={href:"https://www.rollupjs.com/guide/introduction#tree-shaking",target:"_blank",rel:"noopener noreferrer"},g=t(`<p>以下是 <code>rollup 2.77.2</code> 版本的 package.json 文件，我们可以看下它的主要依赖；</p><div class="language-plain line-numbers-mode" data-ext="plain"><pre class="language-plain"><code>{
  &amp;quot;name&amp;quot;: &amp;quot;rollup&amp;quot;,
  &amp;quot;version&amp;quot;: &amp;quot;2.77.2&amp;quot;,
  &amp;quot;description&amp;quot;: &amp;quot;Next-generation ES module bundler&amp;quot;,
  &amp;quot;main&amp;quot;: &amp;quot;dist/rollup.js&amp;quot;,
  &amp;quot;module&amp;quot;: &amp;quot;dist/es/rollup.js&amp;quot;,
  &amp;quot;typings&amp;quot;: &amp;quot;dist/rollup.d.ts&amp;quot;,
  &amp;quot;bin&amp;quot;: {
    &amp;quot;rollup&amp;quot;: &amp;quot;dist/bin/rollup&amp;quot;
  },
  &amp;quot;devDependencies&amp;quot;: {
    &amp;quot;@rollup/plugin-alias&amp;quot;: &amp;quot;^3.1.9&amp;quot;,
    &amp;quot;@rollup/plugin-buble&amp;quot;: &amp;quot;^0.21.3&amp;quot;,
    &amp;quot;@rollup/plugin-commonjs&amp;quot;: &amp;quot;^22.0.1&amp;quot;,
    &amp;quot;@rollup/plugin-json&amp;quot;: &amp;quot;^4.1.0&amp;quot;,
    &amp;quot;@rollup/plugin-node-resolve&amp;quot;: &amp;quot;^13.3.0&amp;quot;,
    &amp;quot;@rollup/plugin-replace&amp;quot;: &amp;quot;^4.0.0&amp;quot;,
    &amp;quot;@rollup/plugin-typescript&amp;quot;: &amp;quot;^8.3.3&amp;quot;,
    &amp;quot;@rollup/pluginutils&amp;quot;: &amp;quot;^4.2.1&amp;quot;,
    &amp;quot;acorn&amp;quot;: &amp;quot;^8.7.1&amp;quot;, // 生成 AST 语法树
    &amp;quot;acorn-jsx&amp;quot;: &amp;quot;^5.3.2&amp;quot;, // 针对 jsx 语法分析
    &amp;quot;acorn-walk&amp;quot;: &amp;quot;^8.2.0&amp;quot;, // 递归生成对象
    &amp;quot;magic-string&amp;quot;: &amp;quot;^0.26.2&amp;quot;, // 语句的替换
    ......,
  },
......
}
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div>`,2),h={href:"https://github.com/acornjs/acorn",target:"_blank",rel:"noopener noreferrer"},q={href:"https://github.com/rich-harris/magic-string#readme",target:"_blank",rel:"noopener noreferrer"},y=n("img",{src:"https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/9325286cf1c54ae38210ebfadd39192d~tplv-k3u1fbpfcp-zoom-1.image",alt:"image (5).png"},null,-1),f=t(`<p>与 Webpack 不同的是，Rollup 不仅仅针对模块进行依赖分析，它的分析流程如下：</p><ol><li>从入口文件开始，组织依赖关系，并按文件生成 Module</li><li>生成抽象语法树（Acorn），建立语句间的关联关系</li><li>为每个节点打标，标记是否被使用</li><li>生成代码（MagicString+ position）去除无用代码</li></ol><h4 id="rollup-的优势" tabindex="-1"><a class="header-anchor" href="#rollup-的优势" aria-hidden="true">#</a> Rollup 的优势</h4><ol><li>它支持导出 ES 模块的包。</li><li>它支持程序流分析，能更加正确的判断项目本身的代码是否有副作用。</li></ol><h3 id="两个-case" tabindex="-1"><a class="header-anchor" href="#两个-case" aria-hidden="true">#</a> 两个 Case</h3><ol><li>案例 1： Import 但未调用，不可消除</li></ol><div class="language-plain line-numbers-mode" data-ext="plain"><pre class="language-plain"><code>import pkgjson from &amp;#39;../package.json&amp;#39;;

export function getMeta (version: string) {
  return {
    lver: version || pkgjson.version,
  }
}
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>编译后整个 package.json 都被打了进来，代码块如下：</p><div class="language-javascript line-numbers-mode" data-ext="js"><pre class="language-javascript"><code><span class="token keyword">var</span> name <span class="token operator">=</span> <span class="token operator">&amp;</span>quot<span class="token punctuation">;</span>@zcy<span class="token operator">/</span>xxxxx<span class="token operator">-</span>sdk<span class="token operator">&amp;</span>quot<span class="token punctuation">;</span><span class="token punctuation">;</span>
<span class="token keyword">var</span> version$1 <span class="token operator">=</span> <span class="token operator">&amp;</span>quot<span class="token punctuation">;</span><span class="token number">0.0</span><span class="token number">.1</span><span class="token operator">-</span>beta<span class="token operator">&amp;</span>quot<span class="token punctuation">;</span><span class="token punctuation">;</span>
<span class="token keyword">var</span> description <span class="token operator">=</span> <span class="token operator">&amp;</span>quot<span class="token punctuation">;</span><span class="token operator">&amp;</span>quot<span class="token punctuation">;</span><span class="token punctuation">;</span>
<span class="token keyword">var</span> main <span class="token operator">=</span> <span class="token operator">&amp;</span>quot<span class="token punctuation">;</span>lib<span class="token operator">/</span>index<span class="token punctuation">.</span>es<span class="token punctuation">.</span>js<span class="token operator">&amp;</span>quot<span class="token punctuation">;</span><span class="token punctuation">;</span>
<span class="token keyword">var</span> module$1 <span class="token operator">=</span> <span class="token operator">&amp;</span>quot<span class="token punctuation">;</span>lib<span class="token operator">/</span>index<span class="token punctuation">.</span>cjs<span class="token punctuation">.</span>js<span class="token operator">&amp;</span>quot<span class="token punctuation">;</span><span class="token punctuation">;</span>
<span class="token keyword">var</span> browser <span class="token operator">=</span> <span class="token operator">&amp;</span>quot<span class="token punctuation">;</span>lib<span class="token operator">/</span>index<span class="token punctuation">.</span>umd<span class="token punctuation">.</span>js<span class="token operator">&amp;</span>quot<span class="token punctuation">;</span><span class="token punctuation">;</span>
<span class="token keyword">var</span> types <span class="token operator">=</span> <span class="token operator">&amp;</span>quot<span class="token punctuation">;</span>lib<span class="token operator">/</span>index<span class="token punctuation">.</span>d<span class="token punctuation">.</span>ts<span class="token operator">&amp;</span>quot<span class="token punctuation">;</span><span class="token punctuation">;</span>
<span class="token keyword">var</span> scripts <span class="token operator">=</span> <span class="token punctuation">{</span>
  <span class="token literal-property property">test</span><span class="token operator">:</span> <span class="token operator">&amp;</span>quot<span class="token punctuation">;</span>jest <span class="token operator">--</span>color  <span class="token operator">--</span>coverage<span class="token operator">=</span><span class="token boolean">true</span><span class="token operator">&amp;</span>quot<span class="token punctuation">;</span><span class="token punctuation">,</span>
  <span class="token literal-property property">doc</span><span class="token operator">:</span> <span class="token operator">&amp;</span>quot<span class="token punctuation">;</span>rm <span class="token operator">-</span>rf doc <span class="token operator">&amp;</span>amp<span class="token punctuation">;</span><span class="token operator">&amp;</span>amp<span class="token punctuation">;</span> typedoc <span class="token operator">--</span>out doc <span class="token punctuation">.</span><span class="token operator">/</span>src<span class="token operator">&amp;</span>quot<span class="token punctuation">;</span><span class="token punctuation">,</span>
  <span class="token operator">...</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token keyword">var</span> repository <span class="token operator">=</span> <span class="token punctuation">{</span>
  <span class="token literal-property property">type</span><span class="token operator">:</span> <span class="token operator">&amp;</span>quot<span class="token punctuation">;</span>git<span class="token operator">&amp;</span>quot<span class="token punctuation">;</span><span class="token punctuation">,</span>
  <span class="token literal-property property">url</span><span class="token operator">:</span> <span class="token operator">&amp;</span>quot<span class="token punctuation">;</span><span class="token operator">...</span><span class="token operator">...</span><span class="token operator">&amp;</span>quot<span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token keyword">var</span> author <span class="token operator">=</span> <span class="token operator">&amp;</span>quot<span class="token punctuation">;</span><span class="token operator">&amp;</span>quot<span class="token punctuation">;</span><span class="token punctuation">;</span>
<span class="token keyword">var</span> license <span class="token operator">=</span> <span class="token operator">&amp;</span>quot<span class="token punctuation">;</span><span class="token constant">ISC</span><span class="token operator">&amp;</span>quot<span class="token punctuation">;</span><span class="token punctuation">;</span>
<span class="token keyword">var</span> devDependencies <span class="token operator">=</span> <span class="token punctuation">{</span>
  <span class="token operator">&amp;</span>quot<span class="token punctuation">;</span>@babel<span class="token operator">/</span>core<span class="token operator">&amp;</span>quot<span class="token punctuation">;</span><span class="token operator">:</span> <span class="token operator">&amp;</span>quot<span class="token punctuation">;</span><span class="token operator">^</span><span class="token number">7.15</span><span class="token number">.5</span><span class="token operator">&amp;</span>quot<span class="token punctuation">;</span><span class="token punctuation">,</span>
  <span class="token operator">&amp;</span>quot<span class="token punctuation">;</span>@babel<span class="token operator">/</span>preset<span class="token operator">-</span>env<span class="token operator">&amp;</span>quot<span class="token punctuation">;</span><span class="token operator">:</span> <span class="token operator">&amp;</span>quot<span class="token punctuation">;</span><span class="token operator">^</span><span class="token number">7.15</span><span class="token number">.4</span><span class="token operator">&amp;</span>quot<span class="token punctuation">;</span><span class="token punctuation">,</span>
  <span class="token operator">&amp;</span>quot<span class="token punctuation">;</span>@babel<span class="token operator">/</span>runtime<span class="token operator">-</span>corejs3<span class="token operator">&amp;</span>quot<span class="token punctuation">;</span><span class="token operator">:</span> <span class="token operator">&amp;</span>quot<span class="token punctuation">;</span><span class="token operator">^</span><span class="token number">7.11</span><span class="token number">.2</span><span class="token operator">&amp;</span>quot<span class="token punctuation">;</span><span class="token punctuation">,</span>
  <span class="token operator">&amp;</span>quot<span class="token punctuation">;</span>@types<span class="token operator">/</span>jest<span class="token operator">&amp;</span>quot<span class="token punctuation">;</span><span class="token operator">:</span> <span class="token operator">&amp;</span>quot<span class="token punctuation">;</span><span class="token operator">^</span><span class="token number">24.9</span><span class="token number">.1</span><span class="token operator">&amp;</span>quot<span class="token punctuation">;</span><span class="token punctuation">,</span>
  <span class="token operator">&amp;</span>quot<span class="token punctuation">;</span>@typescript<span class="token operator">-</span>eslint<span class="token operator">/</span>eslint<span class="token operator">-</span>plugin<span class="token operator">&amp;</span>quot<span class="token punctuation">;</span><span class="token operator">:</span> <span class="token operator">&amp;</span>quot<span class="token punctuation">;</span><span class="token operator">^</span><span class="token number">2.34</span><span class="token number">.0</span><span class="token operator">&amp;</span>quot<span class="token punctuation">;</span><span class="token punctuation">,</span>
  <span class="token operator">&amp;</span>quot<span class="token punctuation">;</span>@typescript<span class="token operator">-</span>eslint<span class="token operator">/</span>parser<span class="token operator">&amp;</span>quot<span class="token punctuation">;</span><span class="token operator">:</span> <span class="token operator">&amp;</span>quot<span class="token punctuation">;</span><span class="token operator">^</span><span class="token number">2.34</span><span class="token number">.0</span><span class="token operator">&amp;</span>quot<span class="token punctuation">;</span><span class="token punctuation">,</span>
  <span class="token operator">&amp;</span>quot<span class="token punctuation">;</span>babel<span class="token operator">-</span>loader<span class="token operator">&amp;</span>quot<span class="token punctuation">;</span><span class="token operator">:</span> <span class="token operator">&amp;</span>quot<span class="token punctuation">;</span><span class="token operator">^</span><span class="token number">8.2</span><span class="token number">.2</span><span class="token operator">&amp;</span>quot<span class="token punctuation">;</span><span class="token punctuation">,</span>
  <span class="token literal-property property">eslint</span><span class="token operator">:</span> <span class="token operator">&amp;</span>quot<span class="token punctuation">;</span><span class="token operator">^</span><span class="token number">6.8</span><span class="token number">.0</span><span class="token operator">&amp;</span>quot<span class="token punctuation">;</span><span class="token punctuation">,</span>
  <span class="token operator">&amp;</span>quot<span class="token punctuation">;</span>eslint<span class="token operator">-</span>config<span class="token operator">-</span>alloy<span class="token operator">&amp;</span>quot<span class="token punctuation">;</span><span class="token operator">:</span> <span class="token operator">&amp;</span>quot<span class="token punctuation">;</span><span class="token operator">^</span><span class="token number">3.7</span><span class="token number">.2</span><span class="token operator">&amp;</span>quot<span class="token punctuation">;</span><span class="token punctuation">,</span>
  <span class="token literal-property property">jest</span><span class="token operator">:</span> <span class="token operator">&amp;</span>quot<span class="token punctuation">;</span><span class="token operator">^</span><span class="token number">24.9</span><span class="token number">.0</span><span class="token operator">&amp;</span>quot<span class="token punctuation">;</span><span class="token punctuation">,</span>
  <span class="token operator">&amp;</span>quot<span class="token punctuation">;</span>lodash<span class="token punctuation">.</span>camelcase<span class="token operator">&amp;</span>quot<span class="token punctuation">;</span><span class="token operator">:</span> <span class="token operator">&amp;</span>quot<span class="token punctuation">;</span><span class="token operator">^</span><span class="token number">4.3</span><span class="token number">.0</span><span class="token operator">&amp;</span>quot<span class="token punctuation">;</span><span class="token punctuation">,</span>
  <span class="token literal-property property">path</span><span class="token operator">:</span> <span class="token operator">&amp;</span>quot<span class="token punctuation">;</span><span class="token operator">^</span><span class="token number">0.12</span><span class="token number">.7</span><span class="token operator">&amp;</span>quot<span class="token punctuation">;</span><span class="token punctuation">,</span>
  <span class="token literal-property property">prettier</span><span class="token operator">:</span> <span class="token operator">&amp;</span>quot<span class="token punctuation">;</span><span class="token operator">^</span><span class="token number">1.19</span><span class="token number">.1</span><span class="token operator">&amp;</span>quot<span class="token punctuation">;</span><span class="token punctuation">,</span>
  <span class="token literal-property property">rollup</span><span class="token operator">:</span> <span class="token operator">&amp;</span>quot<span class="token punctuation">;</span><span class="token operator">^</span><span class="token number">1.32</span><span class="token number">.1</span><span class="token operator">&amp;</span>quot<span class="token punctuation">;</span><span class="token punctuation">,</span>
  <span class="token operator">...</span>
<span class="token punctuation">.</span>  
<span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token keyword">var</span> dependencies <span class="token operator">=</span> <span class="token punctuation">{</span>
  <span class="token operator">&amp;</span>quot<span class="token punctuation">;</span>@babel<span class="token operator">/</span>plugin<span class="token operator">-</span>transform<span class="token operator">-</span>runtime<span class="token operator">&amp;</span>quot<span class="token punctuation">;</span><span class="token operator">:</span> <span class="token operator">&amp;</span>quot<span class="token punctuation">;</span><span class="token operator">^</span><span class="token number">7.10</span><span class="token number">.5</span><span class="token operator">&amp;</span>quot<span class="token punctuation">;</span><span class="token punctuation">,</span>
  <span class="token operator">&amp;</span>quot<span class="token punctuation">;</span>@rollup<span class="token operator">/</span>plugin<span class="token operator">-</span>json<span class="token operator">&amp;</span>quot<span class="token punctuation">;</span><span class="token operator">:</span> <span class="token operator">&amp;</span>quot<span class="token punctuation">;</span><span class="token operator">^</span><span class="token number">4.1</span><span class="token number">.0</span><span class="token operator">&amp;</span>quot<span class="token punctuation">;</span><span class="token punctuation">,</span>
  <span class="token operator">&amp;</span>quot<span class="token punctuation">;</span>core<span class="token operator">-</span>js<span class="token operator">&amp;</span>quot<span class="token punctuation">;</span><span class="token operator">:</span> <span class="token operator">&amp;</span>quot<span class="token punctuation">;</span><span class="token operator">^</span><span class="token number">3.6</span><span class="token number">.5</span><span class="token operator">&amp;</span>quot<span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token keyword">var</span> sideEffects <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
<span class="token keyword">var</span> pkgjson <span class="token operator">=</span> <span class="token punctuation">{</span>
  <span class="token literal-property property">name</span><span class="token operator">:</span> name<span class="token punctuation">,</span>
  <span class="token literal-property property">version</span><span class="token operator">:</span> version$1<span class="token punctuation">,</span>
  <span class="token literal-property property">description</span><span class="token operator">:</span> description<span class="token punctuation">,</span>
  <span class="token literal-property property">main</span><span class="token operator">:</span> main<span class="token punctuation">,</span>
  <span class="token literal-property property">module</span><span class="token operator">:</span> module$1<span class="token punctuation">,</span>
  <span class="token literal-property property">browser</span><span class="token operator">:</span> browser<span class="token punctuation">,</span>
  <span class="token literal-property property">types</span><span class="token operator">:</span> types<span class="token punctuation">,</span>
  <span class="token literal-property property">scripts</span><span class="token operator">:</span> scripts<span class="token punctuation">,</span>
  <span class="token literal-property property">repository</span><span class="token operator">:</span> repository<span class="token punctuation">,</span>
  <span class="token literal-property property">author</span><span class="token operator">:</span> author<span class="token punctuation">,</span>
  <span class="token literal-property property">license</span><span class="token operator">:</span> license<span class="token punctuation">,</span>
  <span class="token literal-property property">devDependencies</span><span class="token operator">:</span> devDependencies<span class="token punctuation">,</span>
  <span class="token literal-property property">dependencies</span><span class="token operator">:</span> dependencies<span class="token punctuation">,</span>
  <span class="token literal-property property">sideEffects</span><span class="token operator">:</span> sideEffects<span class="token punctuation">,</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>未 import 的部分可消除</p><div class="language-plain line-numbers-mode" data-ext="plain"><pre class="language-plain"><code>import { version } from &amp;#39;../package.json&amp;#39;;
​
export function getMeta (ver: string) {
  return {
    lver: ver || version,
  }
}
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>编译后可以发现，version 作为一个常量被单独打包进来；代码块如下：</p><div class="language-javascript line-numbers-mode" data-ext="js"><pre class="language-javascript"><code><span class="token keyword">var</span> version$1 <span class="token operator">=</span> <span class="token operator">&amp;</span>quot<span class="token punctuation">;</span><span class="token number">0.0</span><span class="token number">.1</span><span class="token operator">-</span>beta<span class="token operator">&amp;</span>quot<span class="token punctuation">;</span><span class="token punctuation">;</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><ol start="2"><li>案例 2： <strong>变量影响了全局变量</strong></li></ol><div class="language-plain line-numbers-mode" data-ext="plain"><pre class="language-plain"><code>window.utm = &amp;#39;a.b.c&amp;#39;;
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><p>即使 <code>utm</code> 没有任何地方被使用到，在编译打包的过程中，上述代码也不能被去除。 因此我们可以得出结论：</p><ol><li>在 import 三方工具库、组件库时不要全量 import。</li><li>设置或改动全局变量需谨慎。</li></ol><h4 id="vue3-针对-tree-shaking-所做的优化" tabindex="-1"><a class="header-anchor" href="#vue3-针对-tree-shaking-所做的优化" aria-hidden="true">#</a> Vue3 针对 Tree-shaking 所做的优化</h4><p>在 Vue2.x 中，你一定见过以下引入方式：</p><div class="language-javascript line-numbers-mode" data-ext="js"><pre class="language-javascript"><code><span class="token keyword">import</span> Vue from <span class="token operator">&amp;</span>#<span class="token number">39</span><span class="token punctuation">;</span>vue<span class="token operator">&amp;</span>#<span class="token number">39</span><span class="token punctuation">;</span>
​
Vue<span class="token punctuation">.</span><span class="token function">nextTick</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=</span><span class="token operator">&amp;</span>gt<span class="token punctuation">;</span> <span class="token punctuation">{</span>
  <span class="token comment">// 一些和 DOM 有关的东西</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div>`,20),x=n("code",null,"Vue.nextTick()",-1),_=n("code",null,"export",-1),j=n("code",null,"nextTick",-1),w={href:"https://v3.cn.vuejs.org/guide/migration/global-api-treeshaking.html",target:"_blank",rel:"noopener noreferrer"},T=t(`<p>有了这些能力之后，我们可以不再过于关注框架总体的体积了，因为按需打包使得我们只需要关注那些我们已经使用到的功能和代码。</p><h4 id="最终效果对比" tabindex="-1"><a class="header-anchor" href="#最终效果对比" aria-hidden="true">#</a> 最终效果对比</h4><p>先分别来看下两种打包工具的配置；</p><p>webpack.config.js :</p><div class="language-javascript line-numbers-mode" data-ext="js"><pre class="language-javascript"><code><span class="token keyword">const</span> webpack <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>#<span class="token number">39</span><span class="token punctuation">;</span>webpack<span class="token operator">&amp;</span>#<span class="token number">39</span><span class="token punctuation">;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> path <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>#<span class="token number">39</span><span class="token punctuation">;</span>path<span class="token operator">&amp;</span>#<span class="token number">39</span><span class="token punctuation">;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">// 删除 const UglifyJsPlugin = require(&amp;#39;uglifyjs-webpack-plugin&amp;#39;);</span>
​
module<span class="token punctuation">.</span>exports <span class="token operator">=</span> <span class="token punctuation">{</span>
  entry<span class="token operator">:</span> path<span class="token punctuation">.</span><span class="token function">join</span><span class="token punctuation">(</span>__dirname<span class="token punctuation">,</span> <span class="token operator">&amp;</span>#<span class="token number">39</span><span class="token punctuation">;</span>src<span class="token operator">/</span>index<span class="token punctuation">.</span>ts<span class="token operator">&amp;</span>#<span class="token number">39</span><span class="token punctuation">;</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
  output<span class="token operator">:</span> <span class="token punctuation">{</span><span class="token literal-property property">filename</span><span class="token operator">:</span> <span class="token operator">&amp;</span>#<span class="token number">39</span><span class="token punctuation">;</span>webpack<span class="token punctuation">.</span>bundle<span class="token punctuation">.</span>js<span class="token operator">&amp;</span>#<span class="token number">39</span><span class="token punctuation">;</span><span class="token punctuation">}</span><span class="token punctuation">,</span>
  module<span class="token operator">:</span> <span class="token punctuation">{</span>
    rules<span class="token operator">:</span> <span class="token punctuation">[</span>
      <span class="token punctuation">{</span>
        test<span class="token operator">:</span> <span class="token regex"><span class="token regex-delimiter">/</span><span class="token regex-source language-regex">\\.(js|ts|tsx)$</span><span class="token regex-delimiter">/</span></span><span class="token punctuation">,</span>
        exclude<span class="token operator">:</span> <span class="token regex"><span class="token regex-delimiter">/</span><span class="token regex-source language-regex">(node_modules|bower_components|lib)</span><span class="token regex-delimiter">/</span></span><span class="token punctuation">,</span>
        use<span class="token operator">:</span> <span class="token punctuation">{</span>
          loader<span class="token operator">:</span> <span class="token operator">&amp;</span>#<span class="token number">39</span><span class="token punctuation">;</span>babel<span class="token operator">-</span>loader<span class="token operator">&amp;</span>#<span class="token number">39</span><span class="token punctuation">;</span><span class="token punctuation">,</span>
          options<span class="token operator">:</span> <span class="token punctuation">{</span>
            presets<span class="token operator">:</span> <span class="token punctuation">[</span><span class="token operator">&amp;</span>#<span class="token number">39</span><span class="token punctuation">;</span>@babel<span class="token operator">/</span>preset<span class="token operator">-</span>env<span class="token operator">&amp;</span>#<span class="token number">39</span><span class="token punctuation">;</span><span class="token punctuation">]</span>
          <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
      <span class="token punctuation">}</span><span class="token punctuation">,</span>
      <span class="token punctuation">{</span>
        test<span class="token operator">:</span> <span class="token regex"><span class="token regex-delimiter">/</span><span class="token regex-source language-regex">\\.tsx?$</span><span class="token regex-delimiter">/</span></span><span class="token punctuation">,</span>
        use<span class="token operator">:</span> <span class="token operator">&amp;</span>#<span class="token number">39</span><span class="token punctuation">;</span>ts<span class="token operator">-</span>loader<span class="token operator">&amp;</span>#<span class="token number">39</span><span class="token punctuation">;</span><span class="token punctuation">,</span>
        exclude<span class="token operator">:</span> <span class="token regex"><span class="token regex-delimiter">/</span><span class="token regex-source language-regex">(node_modules|lib)</span><span class="token regex-delimiter">/</span></span><span class="token punctuation">,</span>
      <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token punctuation">]</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
  resolve<span class="token operator">:</span> <span class="token punctuation">{</span>
    extensions<span class="token operator">:</span> <span class="token punctuation">[</span><span class="token operator">&amp;</span>#<span class="token number">39</span><span class="token punctuation">;</span><span class="token punctuation">.</span>tsx<span class="token operator">&amp;</span>#<span class="token number">39</span><span class="token punctuation">;</span><span class="token punctuation">,</span> <span class="token operator">&amp;</span>#<span class="token number">39</span><span class="token punctuation">;</span><span class="token punctuation">.</span>ts<span class="token operator">&amp;</span>#<span class="token number">39</span><span class="token punctuation">;</span><span class="token punctuation">,</span> <span class="token operator">&amp;</span>#<span class="token number">39</span><span class="token punctuation">;</span><span class="token punctuation">.</span>js<span class="token operator">&amp;</span>#<span class="token number">39</span><span class="token punctuation">;</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
  optimization<span class="token operator">:</span> <span class="token punctuation">{</span> <span class="token comment">// tree-shaking 优化配置</span>
    usedExports<span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
  plugins<span class="token operator">:</span> <span class="token punctuation">[</span>
    <span class="token keyword">new</span> <span class="token class-name">webpack<span class="token punctuation">.</span>optimize<span class="token punctuation">.</span>ModuleConcatenationPlugin</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
  <span class="token punctuation">]</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>rollup.config.js :</p><div class="language-javascript line-numbers-mode" data-ext="js"><pre class="language-javascript"><code><span class="token keyword">import</span> resolve from <span class="token operator">&amp;</span>quot<span class="token punctuation">;</span>rollup<span class="token operator">-</span>plugin<span class="token operator">-</span>node<span class="token operator">-</span>resolve<span class="token operator">&amp;</span>quot<span class="token punctuation">;</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> commonjs from <span class="token operator">&amp;</span>quot<span class="token punctuation">;</span>rollup<span class="token operator">-</span>plugin<span class="token operator">-</span>commonjs<span class="token operator">&amp;</span>quot<span class="token punctuation">;</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> typescript from <span class="token operator">&amp;</span>quot<span class="token punctuation">;</span>rollup<span class="token operator">-</span>plugin<span class="token operator">-</span>typescript2<span class="token operator">&amp;</span>quot<span class="token punctuation">;</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> babel from <span class="token operator">&amp;</span>quot<span class="token punctuation">;</span>rollup<span class="token operator">-</span>plugin<span class="token operator">-</span>babel<span class="token operator">&amp;</span>quot<span class="token punctuation">;</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> json from <span class="token operator">&amp;</span>quot<span class="token punctuation">;</span>rollup<span class="token operator">-</span>plugin<span class="token operator">-</span>json<span class="token operator">&amp;</span>quot<span class="token punctuation">;</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span> uglify <span class="token punctuation">}</span> from <span class="token operator">&amp;</span>#<span class="token number">39</span><span class="token punctuation">;</span>rollup<span class="token operator">-</span>plugin<span class="token operator">-</span>uglify<span class="token operator">&amp;</span>#<span class="token number">39</span><span class="token punctuation">;</span>
​
<span class="token keyword">export</span> <span class="token keyword">default</span> <span class="token punctuation">{</span>
  input<span class="token operator">:</span> <span class="token operator">&amp;</span>quot<span class="token punctuation">;</span>src<span class="token operator">/</span>index<span class="token punctuation">.</span>ts<span class="token operator">&amp;</span>quot<span class="token punctuation">;</span><span class="token punctuation">,</span>
  output<span class="token operator">:</span> <span class="token punctuation">[</span>
    <span class="token punctuation">{</span> <span class="token literal-property property">file</span><span class="token operator">:</span> <span class="token operator">&amp;</span>quot<span class="token punctuation">;</span>lib<span class="token operator">/</span>index<span class="token punctuation">.</span>cjs<span class="token punctuation">.</span>js<span class="token operator">&amp;</span>quot<span class="token punctuation">;</span><span class="token punctuation">,</span> <span class="token literal-property property">format</span><span class="token operator">:</span> <span class="token operator">&amp;</span>quot<span class="token punctuation">;</span>cjs<span class="token operator">&amp;</span>quot<span class="token punctuation">;</span> <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token punctuation">]</span><span class="token punctuation">,</span>
  treeshake<span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span> <span class="token comment">// treeshake 开关</span>
  plugins<span class="token operator">:</span> <span class="token punctuation">[</span>
    <span class="token function">json</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    <span class="token function">typescript</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    <span class="token function">resolve</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    <span class="token function">commonjs</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    <span class="token function">babel</span><span class="token punctuation">(</span>
      <span class="token punctuation">{</span>
        exclude<span class="token operator">:</span> <span class="token operator">&amp;</span>quot<span class="token punctuation">;</span>node_modules<span class="token doc-comment comment">/**&amp;quot;,
        runtimeHelpers: true,
        sourceMap: true,
        extensions: [&amp;quot;.js&amp;quot;, &amp;quot;.jsx&amp;quot;, &amp;quot;.es6&amp;quot;, &amp;quot;.es&amp;quot;, &amp;quot;.mjs&amp;quot;, &amp;quot;.ts&amp;quot;, &amp;quot;.json&amp;quot;],
      <span class="token punctuation">}</span>
    ),
    uglify(),
  ],
<span class="token punctuation">}</span>;
</span></code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>最后来看下打包结果的对比。结果发现，本项目在配置 <code>sideEffects：false</code> 前后时长和体积没有明显变化。</p><table><thead><tr><th style="text-align:left;">对比</th><th style="text-align:left;">Tree-Shaking 前体积</th><th style="text-align:left;">Tree-Shaking 后体积</th><th style="text-align:left;">打包时长</th></tr></thead><tbody><tr><td style="text-align:left;">webpack（5.52.0）</td><td style="text-align:left;">46kb</td><td style="text-align:left;">44kb</td><td style="text-align:left;">4.8s</td></tr><tr><td style="text-align:left;">rollup（1.32.1）</td><td style="text-align:left;">24kb</td><td style="text-align:left;">18kb</td><td style="text-align:left;">3.7s</td></tr></tbody></table><p>另，上述打包效果中的项目是 sdk 工具包。</p><h3 id="结束语" tabindex="-1"><a class="header-anchor" href="#结束语" aria-hidden="true">#</a> 结束语</h3>`,11),E={href:"https://www.zoo.team/article/about-vite",target:"_blank",rel:"noopener noreferrer"},S=n("h3",{id:"推荐阅读",tabindex:"-1"},[n("a",{class:"header-anchor",href:"#推荐阅读","aria-hidden":"true"},"#"),s(" 推荐阅读")],-1),z={href:"https://juejin.cn/post/7021115814870810660",target:"_blank",rel:"noopener noreferrer"},R=n("h2",{id:"推荐阅读-1",tabindex:"-1"},[n("a",{class:"header-anchor",href:"#推荐阅读-1","aria-hidden":"true"},"#"),s(" 推荐阅读")],-1),$={href:"https://juejin.cn/post/7166416369943068679",target:"_blank",rel:"noopener noreferrer"},P={href:"https://juejin.cn/post/7163801933612843016",target:"_blank",rel:"noopener noreferrer"},M={href:"https://juejin.cn/post/7153410606673395725",target:"_blank",rel:"noopener noreferrer"},V={href:"https://juejin.cn/post/7145604963593355277",target:"_blank",rel:"noopener noreferrer"},W={href:"https://juejin.cn/post/7143025612267978760",target:"_blank",rel:"noopener noreferrer"},A=n("h2",{id:"开源作品",tabindex:"-1"},[n("a",{class:"header-anchor",href:"#开源作品","aria-hidden":"true"},"#"),s(" 开源作品")],-1),C=n("ul",null,[n("li",null,"政采云前端小报")],-1),I={href:"http://zoo.zhengcaiyun.cn/",target:"_blank",rel:"noopener noreferrer"},J=n("ul",null,[n("li",null,"商品选择 sku 插件")],-1),N={href:"https://github.com/zcy-inc/skuPathFinder-back",target:"_blank",rel:"noopener noreferrer"},G=n("h2",{id:"招贤纳士",tabindex:"-1"},[n("a",{class:"header-anchor",href:"#招贤纳士","aria-hidden":"true"},"#"),s(" 招贤纳士")],-1),D=n("p",null,"政采云前端团队（ZooTeam），一个年轻富有激情和创造力的前端团队，隶属于政采云产品研发部，Base 在风景如画的杭州。团队现有 90 余个前端小伙伴，平均年龄 27 岁，近 4 成是全栈工程师，妥妥的青年风暴团。成员构成既有来自于阿里、网易的“老”兵，也有浙大、中科大、杭电等校的应届新人。团队在日常的业务对接之外，还在物料体系、工程平台、搭建平台、性能体验、云端应用、数据分析及可视化等方向进行技术探索和实战，推动并落地了一系列的内部技术产品，持续探索前端技术体系的新边界。",-1),B=n("p",null,[s("如果你想改变一直被事折腾，希望开始能折腾事；如果你想改变一直被告诫需要多些想法，却无从破局；如果你想改变你有能力去做成那个结果，却不需要你；如果你想改变你想做成的事需要一个团队去支撑，但没你带人的位置；如果你想改变既定的节奏，将会是“5 年工作时间 3 年工作经验”；如果你想改变本来悟性不错，但总是有那一层窗户纸的模糊… 如果你相信相信的力量，相信平凡人能成就非凡事，相信能遇到更好的自己。如果你希望参与到随着业务腾飞的过程，亲手推动一个有着深入的业务理解、完善的技术体系、技术创造价值、影响力外溢的前端团队的成长历程，我觉得我们该聊聊。任何时间，等着你写点什么，发给 "),n("code",null,"ZooTeam@cai-inc.com")],-1),F=n("p",null,[n("img",{src:"https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/98d3aa3d1f8646a8bcda8cfd9e335a4b~tplv-k3u1fbpfcp-zoom-1.image",alt:""})],-1);function L(H,O){const a=c("ExternalLinkIcon");return o(),l("div",null,[r,u,n("p",null,[s("> 这是第 166 篇不掺水的原创，想获取更多原创好文，请搜索公众号关注我们吧~ 本文首发于政采云前端博客："),n("a",k,[s("Rollup 与 Webpack 的 Tree-shaking"),p(a)])]),d,n("h3",m,[v,s(),n("a",b,[s("Rollup Tree-shaking "),p(a)]),s("机制")]),g,n("p",null,[s("想要详细了解Acorn：A tiny, fast JavaScript parser, written completely in JavaScript.可"),n("a",h,[s("查看"),p(a)]),s("，Magic-string，可"),n("a",q,[s("查看"),p(a)]),s(" 。rollup源码中各个模块的执行顺序大致如下图，这也基本表明了它的分析流程。 "),y]),f,n("p",null,[s("很可惜的是，像 "),x,s(" 这样的全局 API 是不支持 Tree-shaking 的，因为它并没有被单独 "),_,s("；无论 "),j,s(" 方法是否被实际调用，都会被包含在最终的打包产物中。 但在 Vue3，针对全局和内部 API 进行了改造。如果你想更详细的了解 Vue3.x 全局 API Tree-shaking 带来的改动，可以查看"),n("a",w,[s("这里"),p(a)]),s("，里面详细列出了不再兼容的 API，以及在内部帮助器及插件中的使用变化。")]),T,n("p",null,[s("你如果想了解 Rollup 会打包更快的原因，可以查看我之前发布的文章（"),n("a",E,[s("《Vite 特性和部分源码解析》"),p(a)]),s("）。关于 Tree-shaking 的问题也欢迎你在下面留言讨论。")]),S,n("p",null,[n("a",z,[s("《Rollup源码解析》"),p(a)])]),R,n("p",null,[n("a",$,[s("Git 是如何工作的"),p(a)])]),n("p",null,[n("a",P,[s("大数据前端团队生存指南"),p(a)])]),n("p",null,[n("a",M,[s("所见即所得 —— HTML转图片组件开发"),p(a)])]),n("p",null,[n("a",V,[s("探索组件在线预览和调试"),p(a)])]),n("p",null,[n("a",W,[s("规范升级 NPM 包"),p(a)])]),A,C,n("p",null,[n("strong",null,[s("开源地址 "),n("a",I,[s("www.zoo.team/openweekly/"),p(a)])]),s(" (小报官网首页有微信交流群)")]),J,n("p",null,[n("strong",null,[s("开源地址 "),n("a",N,[s("https://github.com/zcy-inc/skuPathFinder-back/"),p(a)])])]),G,D,B,F])}const Z=e(i,[["render",L],["__file","Rollup 与 Webpack 的 Tree-shaking.html.vue"]]);export{Z as default};
